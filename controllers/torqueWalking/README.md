##Module description

This module implements a torque control balancing strategy.
It computes the joint torques and interaction forces at the feet in order to stabilize the following desired dynamics:
    - root link configuration
    - configuration of links in contact with the ground (i.e. left/right foot) 

A regularizing term penalizing high error on desired joint accelerations is used in the control framework.

For modelling details see [An Optimization Based Control Framework for Balancing and Walking: Implementation on the iCub Robot](http://arxiv.org/abs/1707.08359)

###Compatibility
The repository contains a Simulink model: 
	`torqueBalancing.mdl`, which is generated by using Matlab R2017a

Eventually the following Simulink models will be added to the repository:
	`torqueBalancing2015b86.mdl`, which is exported from the first model to be compatible with Matlab R2015b->now
	`torqueBalancing2012b.mdl`, which is exported from the first model to be compatible with Matlab R2012b->now.

Also, the controller is tested in simulation by using Gazebo 7.0. Older versions of Gazebo may lead to scarse, or unstable, control performances.

###Launch procedure
The procedure to run the torque balancing module is still quite elaborate.
Users willing to use the module should follow the following points:

- Set the environment variable YARP_ROBOT_NAME in .bashrc according to the robot one wants to use (e.g. icubGazeboSim for simulations, or iCubGenova01, iCubParis01, etc. for experiments).
- Set the Matlab environment variable YARP_ROBOT_NAME in initTorqueWalking.m, using the line `setenv('YARP_ROBOT_NAME', '<yarp_robot_name>')` (where <yarp_robot_name> is the same as above);
- (Simulation only) Launch yarpserver.
- (Simulation only) Launch gazebo. If you want to use the synchronization between the controller and the simulator to avoid real-time factor related problems, launch gazebo as follows: `gazebo -slibgazebo_yarp_clock.so`. 
- (Simulation only) Insert an iCub model into gazebo.
- Bring the robot in a suitable home position (e.g. `$ yarpmotorgui --from homePoseBalancin.ini`, in the `Global Joints Command` menu, select `Custom Positions` then click on `Move all parts to NewController`)
- Launch `wholeBodyDynamics` device as follows: `YARP_ROBOT_NAME=<yarp_robot_name> yarprobotinterface --config launch-wholebodydynamics.xml`
- (Simulation only) Remove the calibration offsets which were automatically generated when launching the `wholeBodyDynamics` device, sending the command by rpc as follows: `yarp rpc /wholeBodyDynamics/rpc` and typing `resetOffset all` at the command prompt.
- (Robot only) Execute the [sensors calibration script](https://github.com/robotology/codyco-modules/blob/master/src/scripts/twoFeetStandingIdleAndCalib.sh): `$ twoFeetStandingIdleAndCalib.sh`
- Open the simulink model `torqueBalancing.mdl` (or older version).
- Run the module.

##Module details
###Configuration file
At start, the module calls the initialization file initTorqueBalancing.m. Once open, this file contains some configuration variables.
####General section
- `YARP_ROBOT_NAME` : name of the robot to connect to, i.e. 'icubGazeboSim' for simulations, or 'CubGenova01' 'iCubParis01' etc. for experiments
- `WBT_modelName`: module name. Ports will be opened with this name. Default to `matlabTorqueWalking`
- `simulationTime`: time of the simulation/experiment

####Gains
The gains for the robot specified by the variable `YARP_ROBOT_NAME` can be found in the folder `app/robots/YARP_ROBOT_NAME/`. The file gains.m contains several gains and parameters, among which

- `constants.saturationTorque`: saturations to be applied to the output torques. It must be a positive value.
- `gain.x_root.p`, `gain.x_root.d`: proportional and derivative gains for the root link position
(and so on)
- `gain.joints.p`: gains for the joint positions. The size must match the number of torque controlled joints.

#### CoM, root and feet reference (this section needs update)
It is possible to send a `CoM` reference by connecting to the streaming port `comDes:i`. The port expects 9 elements: 3 values for the  desired CoM  position, 3 values for the  desired CoM velocity and 3 values for the  desired CoM acceleration.
Similarly for the root and feet.

#### Joint reference
It is possible to send the impedance resting position as a reference to the streaming port `qdes:i`. This port expects the same number of element as the torque controlled joints. References are in **radians**


#### Citing this contribution (this section needs update)
In case you want to cite the content of this module please refer to [An Optimization Based Control Framework for Balancing and Walking: Implementation on the iCub Robot](http://arxiv.org/abs/1707.08359) and use the following bibtex entry:

```
@unpublished{Charbonneau2017,
  author    = {Marie Charbonneau and Gabriele Nava and Francesco Nori and Daniele Pucci},
  title     = {An Optimization Based Control Framework for Balancing and Walking: Implementation on the iCub Robot},
  note      = {Manuscript submitted for publication},
  year      = {2017},
  url       = {http://arxiv.org/abs/1707.08359}}

```
